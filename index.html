<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Instagram Follower Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body class="bg-light">
    <main class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <h1 class="text-center mb-4">Instagram Follower Comparison</h1>
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="mb-3">
                            <p class="fw-semibold mb-2">Choose data source</p>
                            <div class="form-check">
                                <input checked class="form-check-input" id="sourceJson" name="dataSource" type="radio" value="json">
                                <label class="form-check-label" for="sourceJson">Upload JSON files</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" id="sourceZip" name="dataSource" type="radio" value="zip">
                                <label class="form-check-label" for="sourceZip">Upload Instagram ZIP archive</label>
                            </div>
                        </div>
                        <div class="mb-3" id="json-inputs">
                            <label class="form-label" for="followingFile">Following JSON</label>
                            <input accept=".json" class="form-control" id="followingFile" type="file">
                            <label class="form-label mt-3" for="followersFile">Followers JSON</label>
                            <input accept=".json" class="form-control" id="followersFile" multiple type="file">
                        </div>
                        <div class="mb-3 d-none" id="zip-input">
                            <label class="form-label" for="archiveFile">Instagram data ZIP</label>
                            <input accept=".zip" class="form-control" id="archiveFile" type="file">
                            <div class="form-text">The ZIP should contain <code>connections/followers_and_following/following.json</code> and one or more <code>followers_*.json</code> files.</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" type="button" onclick="checkFollowers()">Check</button>
                            <button class="btn btn-outline-secondary" type="button" onclick="showInfo()">How it works</button>
                        </div>
                    </div>
                </div>
                <div class="alert d-none mb-4" id="status" role="alert"></div>
                <div class="card d-none shadow-sm" id="result-card">
                    <div class="card-body">
                        <h2 class="h5" id="result-message"></h2>
                        <div id="result"></div>
                    </div>
                </div>
                <p class="text-center text-muted mt-4">Created by Phumix â€” <a href="https://github.com/Phumix/Instagram-Unfollow-Checker" target="_blank" rel="noopener noreferrer">open source</a> under the MIT License.</p>
            </div>
        </div>
    </main>

    <div aria-hidden="true" aria-labelledby="infoModalLabel" class="modal fade" id="info-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="infoModalLabel">Instagram Unfollow Checker</h1>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                    <p>This tool compares who you follow with who follows you back on Instagram. Start by downloading your Instagram data archive, then upload the files here.</p>
                    <ol class="mb-3">
                        <li>Log in to Instagram on a computer and request your data: <a href="https://help.instagram.com/181231772500920" target="_blank" rel="noopener noreferrer">Access and download your information</a>.</li>
                        <li>Select JSON as the format and "All time" for the date range.</li>
                        <li>Once you receive the archive, either upload the ZIP file directly or extract <code>following.json</code> and every <code>followers_*.json</code> file from <code>connections/followers_and_following</code>.</li>
                        <li>Click <strong>Check</strong> to list accounts you follow that do not follow you back.</li>
                    </ol>
                    <p class="mb-0">Processing happens entirely in your browser, and no data leaves your device.</p>
                </div>
            </div>
        </div>
    </div>

    <script crossorigin="anonymous" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script>
        let infoModalInstance = null;

        document.addEventListener('DOMContentLoaded', () => {
            updateInputVisibility();
            document.querySelectorAll('input[name="dataSource"]').forEach(radio => {
                radio.addEventListener('change', updateInputVisibility);
            });

            const modalElement = document.getElementById('info-modal');
            if (modalElement && typeof bootstrap !== 'undefined') {
                infoModalInstance = new bootstrap.Modal(modalElement);
            }
        });

        async function checkFollowers() {
            clearFeedback();

            try {
                showStatus('Processing data...', 'info');
                const source = getSelectedSource();
                let followingEntries;
                let followersEntries;

                if (source === 'json') {
                    const followingFile = document.getElementById('followingFile').files[0];
                    const followersInput = document.getElementById('followersFile');
                    const followerFiles = followersInput ? Array.from(followersInput.files || []) : [];

                    if (!followingFile || followerFiles.length === 0) {
                        throw new Error('Upload following.json and at least one followers_*.json file.');
                    }

                    const followingData = await parseJSONFile(followingFile, 'following.json');
                    followingEntries = getRelationshipEntries(followingData, 'following', 'following.json');

                    followersEntries = [];
                    for (const file of followerFiles) {
                        const data = await parseJSONFile(file, file.name || 'followers.json');
                        const normalized = getRelationshipEntries(data, 'followers', file.name || 'followers.json');
                        followersEntries.push(...normalized);
                    }
                } else {
                    const archiveFile = document.getElementById('archiveFile').files[0];
                    if (!archiveFile) {
                        throw new Error('Select the Instagram ZIP archive.');
                    }

                    ({ followingEntries, followersEntries } = await parseArchiveFile(archiveFile));
                }

                if (!followingEntries.length) {
                    throw new Error('No following users found in the provided data.');
                }

                if (!followersEntries.length) {
                    throw new Error('No followers found in the provided data.');
                }

                const followingHandles = extractHandlesFromEntries(followingEntries);
                const followerHandles = extractHandlesFromEntries(followersEntries);

                const followerSet = new Set(followerHandles);
                const uniqueFollowing = Array.from(new Set(followingHandles));
                const notFollowingBack = uniqueFollowing
                    .filter(handle => !followerSet.has(handle))
                    .sort((a, b) => a.localeCompare(b));

                displayResults(notFollowingBack);
                showStatus('Comparison complete.', 'success');
            } catch (error) {
                displayError(error.message || 'An unexpected error occurred.');
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            if (!status) {
                return;
            }
            status.textContent = message;
            status.className = `alert alert-${type} mb-4`;
        }

        function hideStatus() {
            const status = document.getElementById('status');
            if (!status) {
                return;
            }
            status.textContent = '';
            status.className = 'alert d-none mb-4';
        }

        function getSelectedSource() {
            const checked = document.querySelector('input[name="dataSource"]:checked');
            return checked ? checked.value : 'json';
        }

        function updateInputVisibility() {
            const isJson = getSelectedSource() === 'json';
            document.getElementById('json-inputs').classList.toggle('d-none', !isJson);
            document.getElementById('zip-input').classList.toggle('d-none', isJson);
        }

        function clearFeedback() {
            hideStatus();
            hideResults();
        }

        function hideResults() {
            const card = document.getElementById('result-card');
            const resultMessage = document.getElementById('result-message');
            const resultContainer = document.getElementById('result');

            if (card) {
                card.classList.add('d-none');
            }
            if (resultMessage) {
                resultMessage.textContent = '';
            }
            if (resultContainer) {
                resultContainer.innerHTML = '';
            }
        }

        function displayError(message) {
            hideResults();
            showStatus(message, 'danger');
        }

        function displayResults(users) {
            const card = document.getElementById('result-card');
            const resultMessage = document.getElementById('result-message');
            const resultContainer = document.getElementById('result');

            if (!card || !resultMessage || !resultContainer) {
                return;
            }

            card.classList.remove('d-none');
            resultContainer.innerHTML = '';

            if (users.length === 0) {
                resultMessage.textContent = 'Everyone is following you back.';
                const paragraph = document.createElement('p');
                paragraph.className = 'mb-0 text-success';
                paragraph.textContent = 'No unfollowers found.';
                resultContainer.appendChild(paragraph);
                return;
            }

            resultMessage.textContent = `A total of ${users.length} account(s) are not following you back:`;
            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush';

            users.forEach(handle => {
                const item = document.createElement('li');
                item.className = 'list-group-item';
                const link = document.createElement('a');
                link.href = `https://www.instagram.com/${handle}/`;
                link.textContent = handle;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                item.appendChild(link);
                list.appendChild(item);
            });

            resultContainer.appendChild(list);
        }

        async function parseJSONFile(file, contextName) {
            const context = contextName || file.name || 'JSON file';
            let text;
            try {
                text = await readFileAsText(file);
            } catch (error) {
                throw new Error(`Unable to read ${context}: ${error.message}`);
            }

            return parseJSONText(text, context);
        }

        async function parseArchiveFile(file) {
            if (typeof JSZip === 'undefined') {
                throw new Error('ZIP support failed to load. Refresh the page and try again.');
            }

            const buffer = await readFileAsArrayBuffer(file);
            let zip;
            try {
                zip = await JSZip.loadAsync(buffer);
            } catch (error) {
                throw new Error('Unable to open the ZIP archive. Make sure you selected the original Instagram download.');
            }

            const followingEntry = findZipEntry(zip, 'connections/followers_and_following/following.json');
            const followerEntries = findFollowerEntries(zip);

            if (!followingEntry || followerEntries.length === 0) {
                throw new Error('Required files not found in the archive. Expected following.json and at least one followers_*.json in connections/followers_and_following.');
            }

            const followingText = await followingEntry.async('string');
            const followingData = parseJSONText(followingText, 'following.json in archive');
            const followingEntries = getRelationshipEntries(followingData, 'following', 'following.json in archive');

            const followersEntries = [];
            for (const entry of followerEntries) {
                const text = await entry.async('string');
                const context = `${entry.name} in archive`;
                const data = parseJSONText(text, context);
                const normalized = getRelationshipEntries(data, 'followers', context);
                followersEntries.push(...normalized);
            }

            return { followingEntries, followersEntries };
        }

        function findZipEntry(zip, expectedPath) {
            const lowerExpected = expectedPath.toLowerCase();
            for (const path of Object.keys(zip.files)) {
                const entry = zip.files[path];
                if (entry.dir) {
                    continue;
                }
                if (path.toLowerCase().endsWith(lowerExpected)) {
                    return entry;
                }
            }
            return null;
        }

        function findFollowerEntries(zip) {
            const followersPattern = /connections\/followers_and_following\/followers_(\d+)\.json$/i;
            const matches = [];

            for (const path of Object.keys(zip.files)) {
                const entry = zip.files[path];
                if (entry.dir) {
                    continue;
                }
                const match = path.match(followersPattern);
                if (match) {
                    matches.push({ entry, index: parseInt(match[1], 10) });
                }
            }

            if (matches.length > 0) {
                matches.sort((a, b) => a.index - b.index);
                return matches.map(item => item.entry);
            }

            const fallback = findZipEntry(zip, 'connections/followers_and_following/followers.json');
            return fallback ? [fallback] : [];
        }

        function parseJSONText(text, contextName) {
            const normalized = text.replace(/^\uFEFF/, '');
            let parsed;
            try {
                parsed = JSON.parse(normalized);
            } catch (error) {
                throw new Error(`Invalid JSON structure for ${contextName}. ${error.message}`);
            }
            return parsed;
        }

        async function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Unable to read file.'));
                reader.readAsText(file);
            });
        }

        async function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Unable to read file.'));
                reader.readAsArrayBuffer(file);
            });
        }

        function getRelationshipEntries(data, type, contextName) {
            if (!data) {
                throw new Error(`Invalid JSON structure for ${contextName}.`);
            }

            if (Array.isArray(data)) {
                return data;
            }

            const keyOrder = type === 'following'
                ? ['relationships_following', 'following']
                : ['relationships_followers', 'followers', 'relationships_following_you'];

            for (const key of keyOrder) {
                if (Array.isArray(data[key])) {
                    return data[key];
                }
            }

            if (Array.isArray(data.string_list_data)) {
                return data.string_list_data;
            }

            throw new Error(`Invalid JSON structure for ${contextName}. Make sure it is the correct file from your Instagram Data Collection.`);
        }

        function extractHandlesFromEntries(entries) {
            return entries
                .map(entry => extractHandle(entry))
                .filter(Boolean);
        }

        function extractHandle(item) {
            if (!item) {
                return null;
            }

            if (Array.isArray(item.string_list_data) && item.string_list_data.length > 0) {
                const firstEntry = item.string_list_data[0];
                if (firstEntry) {
                    const handleFromHref = typeof firstEntry.href === 'string'
                        ? normalizeInstagramHandle(firstEntry.href)
                        : null;
                    if (handleFromHref) {
                        return handleFromHref;
                    }
                    if (typeof firstEntry.value === 'string' && firstEntry.value.trim()) {
                        return firstEntry.value.trim().toLowerCase();
                    }
                }
            }

            if (typeof item.href === 'string') {
                const handle = normalizeInstagramHandle(item.href);
                if (handle) {
                    return handle;
                }
            }

            if (typeof item.value === 'string' && item.value.trim()) {
                return item.value.trim().toLowerCase();
            }

            if (typeof item.title === 'string' && item.title.trim()) {
                return item.title.trim().toLowerCase();
            }

            return null;
        }

        function normalizeInstagramHandle(url) {
            try {
                const normalized = new URL(url, 'https://www.instagram.com');
                const trimmedPath = normalized.pathname.replace(/^\/+|\/+$/g, '');
                if (!trimmedPath) {
                    return null;
                }

                const segments = trimmedPath.split('/').filter(Boolean);
                if (segments.length === 0) {
                    return null;
                }

                if (segments[0] === '_u' && segments[1]) {
                    return segments[1].toLowerCase();
                }

                return segments[segments.length - 1].toLowerCase();
            } catch (error) {
                return null;
            }
        }

        function showInfo() {
            if (infoModalInstance) {
                infoModalInstance.show();
            }
        }
    </script>
</body>
</html>
